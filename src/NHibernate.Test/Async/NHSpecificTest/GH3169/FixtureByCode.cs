//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by AsyncGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------


using System.Collections.Generic;
using NHibernate.Cfg.MappingSchema;
using NHibernate.Mapping.ByCode;
using NHibernate.Transform;
using NUnit.Framework;

namespace NHibernate.Test.NHSpecificTest.GH3169
{
	using System.Threading.Tasks;
	[TestFixture]
	public class ByCodeFixtureAsync : TestCaseMappingByCode
	{
		class ResultDto
		{
			public string regionCode { get; set; }
		}

		class Entity
		{
			public virtual int Id { get; set; }
			public virtual string Name { get; set; }
		}

		protected override HbmMapping GetMappings()
		{
			var mapper = new ModelMapper();
			mapper.Class<Entity>(rc =>
			{
				rc.Table("Entity");
				rc.Id(x => x.Id, m => m.Generator(Generators.Native));
				rc.Property(x => x.Name);
			});

			return mapper.CompileMappingForAllExplicitlyAddedEntities();
		}

		protected override void OnSetUp()
		{
			using (var session = OpenSession())
			using (var transaction = session.BeginTransaction())
			{
				var e1 = new Entity { Name = "Bob" };
				session.Save(e1);

				transaction.Commit();
			}
		}

		protected override void OnTearDown()
		{
			using (var session = OpenSession())
			using (var transaction = session.BeginTransaction())
			{
				session.CreateQuery("delete from System.Object").ExecuteUpdate();
				transaction.Commit();
			}
		}

		[Test]
		public async Task CachedQueryWithTransformerAsync()
		{
			Task<IList<ResultDto>> GetCacheableSqlQueryResultsAsync(ISession s)
			{
				try
				{
					return s.CreateSQLQuery(
								"select Name as regionCode from Entity")
							.AddScalar("regionCode", NHibernateUtil.String)
							.SetResultTransformer(Transformers.AliasToBean<ResultDto>())
							.SetCacheable(true)
							.ListAsync<ResultDto>();
				}
				catch (System.Exception ex)
				{
					return Task.FromException<IList<ResultDto>>(ex);
				}
			}

			using (var session = OpenSession())
			{
				using (EnableStatisticsScope())
				{
					var l = await (GetCacheableSqlQueryResultsAsync(session));
					Assert.AreEqual(1, l.Count);
					//TODO: Uncomment if we properly fix caching auto discovery type queries with transformers
					//Assert.That(Sfi.Statistics.QueryCacheMissCount, Is.EqualTo(1), "results are expected from DB");
					//Assert.That(Sfi.Statistics.QueryCacheHitCount, Is.EqualTo(0), "results are expected from DB");
				}

				using (EnableStatisticsScope())
				{
					var l2 = await (GetCacheableSqlQueryResultsAsync(session));
					Assert.AreEqual(1, l2.Count);
					//TODO: Uncomment if we properly fix caching auto discovery type queries with transformers
					//Assert.That(Sfi.Statistics.QueryCacheMissCount, Is.EqualTo(0), "results are expected from cache");
					//Assert.That(Sfi.Statistics.QueryCacheHitCount, Is.EqualTo(1), "results are expected from cache");
				}
			}
		}
	}
}
